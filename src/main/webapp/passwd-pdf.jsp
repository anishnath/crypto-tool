<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

<!DOCTYPE html>
<div lang="en">
<head>
    <title>Password Protect PDF - Secure PDF Encryption Tool | 8gwifi.org</title>

    <!-- JSON-LD markup -->
    <script type="application/ld+json">
{
  "@context" : "https://schema.org",
  "@type" : "SoftwareApplication",
  "name" : "Password Protect PDF - Secure PDF Encryption Tool",
  "alternateName" : "PDF Password Protection Online",
  "description" : "Free online tool to password protect PDF files with military-grade encryption. Add password security to PDFs, control printing, copying, and editing permissions. Client-side processing ensures your files remain private.",
  "url" : "https://8gwifi.org/passwd-pdf.jsp",
  "image" : "https://8gwifi.org/images/passwd-pdf.png",
  "screenshot" : "https://8gwifi.org/images/passwd-pdf-screenshot.png",
  "applicationCategory" : "SecurityApplication",
  "applicationSubCategory" : "PDF Security Tool",
  "operatingSystem" : "Any (Web-based)",
  "softwareVersion" : "1.0",
  "datePublished" : "2024-02-19",
  "dateModified" : "2025-01-28",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author" : {
    "@type" : "Person",
    "name" : "Anish Nath",
    "url" : "https://8gwifi.org"
  },
  "publisher" : {
    "@type" : "Organization",
    "name" : "8gwifi.org",
    "url" : "https://8gwifi.org",
    "logo": {
      "@type": "ImageObject",
      "url": "https://8gwifi.org/images/logo.png"
    }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "ratingCount": "312",
    "bestRating": "5",
    "worstRating": "1"
  },
  "featureList" : [
    "Password protect PDF files with strong encryption",
    "Set user and owner passwords",
    "Control document permissions (printing, copying, editing)",
    "100% client-side processing - files never uploaded",
    "No file size limits",
    "Works with all PDF versions",
    "Instant download of protected PDF",
    "Preview file information before protection",
    "No registration required",
    "Free unlimited use"
  ],
  "browserRequirements" : "Requires JavaScript and modern web browser",
  "permissions" : "No special permissions required",
  "inLanguage" : "en-US",
  "isAccessibleForFree" : true,
  "keywords" : "password protect pdf, pdf encryption, secure pdf, pdf password, lock pdf, pdf security, encrypt pdf, pdf permissions, protect pdf online, add password to pdf"
}
    </script>

    <!-- BreadcrumbList -->
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Home",
    "item": "https://8gwifi.org"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": "PDF Tools",
    "item": "https://8gwifi.org/pdf-tools.jsp"
  },{
    "@type": "ListItem",
    "position": 3,
    "name": "Password Protect PDF",
    "item": "https://8gwifi.org/passwd-pdf.jsp"
  }]
}
    </script>

    <!-- HowTo Schema -->
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": "How to Password Protect a PDF File",
  "description": "Step-by-step guide to add password protection to PDF documents",
  "totalTime": "PT1M",
  "step": [{
    "@type": "HowToStep",
    "name": "Upload PDF File",
    "text": "Click 'Choose PDF File' or drag and drop your PDF document into the upload area",
    "position": 1
  },{
    "@type": "HowToStep",
    "name": "Enter Password",
    "text": "Type a strong password that will be required to open the PDF",
    "position": 2
  },{
    "@type": "HowToStep",
    "name": "Configure Permissions",
    "text": "Select which actions are allowed: printing, copying, editing, and annotations",
    "position": 3
  },{
    "@type": "HowToStep",
    "name": "Protect PDF",
    "text": "Click 'Protect PDF' button to encrypt the document",
    "position": 4
  },{
    "@type": "HowToStep",
    "name": "Download",
    "text": "Download your password-protected PDF file",
    "position": 5
  }]
}
    </script>

    <!-- FAQ Schema -->
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": "Is it safe to password protect my PDF online?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "Yes, this tool processes PDFs entirely in your browser using client-side JavaScript. Your files are never uploaded to any server, ensuring complete privacy and security. All encryption happens locally on your device."
    }
  },{
    "@type": "Question",
    "name": "What encryption level is used for PDF passwords?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "This tool uses 128-bit AES encryption, the industry standard for PDF security. This provides military-grade protection for your documents while maintaining compatibility with all modern PDF readers."
    }
  },{
    "@type": "Question",
    "name": "Can I set different user and owner passwords?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "Currently, this tool uses the same password for both user (opening) and owner (editing) access. This ensures anyone with the password has full access to the document."
    }
  },{
    "@type": "Question",
    "name": "What permissions can I control?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "You can control printing (high resolution), copying content, document modification, adding annotations, filling forms, content accessibility, and document assembly. These permissions protect your PDF from unauthorized use."
    }
  },{
    "@type": "Question",
    "name": "Will the password-protected PDF work in all PDF readers?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "Yes, the protected PDFs use standard PDF encryption that is compatible with Adobe Acrobat, Adobe Reader, Preview (Mac), Chrome, Firefox, Edge, and all other modern PDF viewers."
    }
  }]
}
    </script>

    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <meta name="description" content="Free online tool to password protect PDF files. Add encryption, control printing/copying permissions. 100% client-side processing - your files never leave your device. No upload required.">
    <meta name="keywords" content="password protect pdf, pdf encryption, secure pdf, lock pdf, pdf password, encrypt pdf online, pdf security, protect pdf">
    <meta name="author" content="Anish Nath" />
    <meta name="robots" content="index,follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <%@ include file="header-script.jsp"%>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 5px 15px rgba(0,0,0,0.08);
            --border-radius: 8px;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .page-header-compact {
            background: transparent;
            color: white;
            padding: 1rem 0;
            text-align: center;
            margin-bottom: 1rem;
        }

        .page-header-compact h1 {
            font-size: 1.75rem;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .page-header-compact p {
            font-size: 0.9rem;
            margin: 0;
            opacity: 0.95;
        }

        .pdf-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1rem;
        }

        .pdf-panel h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: #495057;
        }

        .input-group-custom {
            margin-bottom: 0.75rem;
        }

        .input-group-custom label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
            color: #495057;
        }

        .input-group-custom small {
            display: block;
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        .pdf-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #dee2e6;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
        }

        .pdf-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-drop-area {
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9fa;
        }

        .file-drop-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .file-drop-area.drag-over {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .file-drop-area i {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .file-info {
            background: #e7f3ff;
            border: 1px solid #667eea;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
        }

        .permission-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .permission-item {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
        }

        .permission-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .pdf-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s;
            width: 100%;
        }

        .pdf-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .pdf-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .pdf-btn.secondary {
            background: #6c757d;
            margin-top: 0.5rem;
        }

        .output-panel {
            position: sticky;
            top: 1rem;
        }

        .output-placeholder {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            color: white;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .output-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.6;
        }

        .output-placeholder h4 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .output-placeholder p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .split-layout {
                grid-template-columns: 1fr;
            }

            .output-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .permission-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<%@ include file="body-script.jsp"%>
<%@ include file="footer_adsense.jsp"%>

<div class="main-wrapper">
    <div class="page-header-compact">
        <h1><i class="fas fa-lock"></i> Password Protect PDF</h1>
        <p>Secure your PDF files with military-grade encryption</p>
    </div>

    <!-- Split Layout: Inputs Left, Outputs Right -->
    <div class="split-layout">
        <!-- LEFT SIDE: Input Panel -->
        <div class="input-panel">
            <!-- Upload Panel -->
            <div class="pdf-panel">
                <h3><i class="fas fa-file-pdf"></i> Upload PDF File</h3>

                <div class="file-drop-area" id="fileDropArea" onclick="document.getElementById('pdfInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">Drop PDF here or click to browse</h4>
                    <p style="font-size: 0.8rem; color: #6c757d; margin: 0;">Maximum file size: Unlimited</p>
                </div>

                <input type="file" id="pdfInput" accept="application/pdf" style="display: none;" onchange="handleFileSelect(event)">

                <div id="fileInfo" style="display: none;"></div>
            </div>

            <!-- Password Panel -->
            <div class="pdf-panel">
                <h3><i class="fas fa-key"></i> Set Password</h3>

                <div class="input-group-custom">
                    <label for="passwordInput"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="passwordInput" class="pdf-input" placeholder="Enter a strong password">
                    <small>Use a combination of letters, numbers, and symbols</small>
                </div>

                <div class="input-group-custom">
                    <label for="confirmPassword"><i class="fas fa-shield-alt"></i> Confirm Password</label>
                    <input type="password" id="confirmPassword" class="pdf-input" placeholder="Re-enter password">
                    <small>Passwords must match</small>
                </div>

                <div style="margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.8rem; cursor: pointer;">
                        <input type="checkbox" id="showPassword" onchange="togglePassword()" style="margin-right: 0.5rem;">
                        Show passwords
                    </label>
                </div>
            </div>

            <!-- Permissions Panel -->
            <div class="pdf-panel">
                <h3><i class="fas fa-user-shield"></i> Document Permissions</h3>

                <div class="permission-grid">
                    <div class="permission-item">
                        <input type="checkbox" id="permPrinting" checked>
                        <label for="permPrinting" style="margin: 0; cursor: pointer;">Allow Printing</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="permCopying">
                        <label for="permCopying" style="margin: 0; cursor: pointer;">Allow Copying</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="permModifying">
                        <label for="permModifying" style="margin: 0; cursor: pointer;">Allow Editing</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="permAnnotating" checked>
                        <label for="permAnnotating" style="margin: 0; cursor: pointer;">Allow Annotations</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="permForms" checked>
                        <label for="permForms" style="margin: 0; cursor: pointer;">Allow Form Filling</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="permAccessibility" checked>
                        <label for="permAccessibility" style="margin: 0; cursor: pointer;">Accessibility</label>
                    </div>
                </div>

                <small style="color: #6c757d; font-size: 0.75rem;">
                    <i class="fas fa-info-circle"></i> These permissions control what users can do with the PDF after opening it with the password.
                </small>
            </div>

            <button class="pdf-btn" id="protectBtn" onclick="protectPDF()" disabled>
                <i class="fas fa-lock"></i> Protect PDF
            </button>
        </div>

        <!-- RIGHT SIDE: Output Panel -->
        <div class="output-panel">
            <div id="outputArea">
                <div class="output-placeholder">
                    <i class="fas fa-arrow-left"></i>
                    <h4>Upload and Protect PDF</h4>
                    <p>Upload a PDF file and set a password<br>to see the protected result here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Tools -->
    <div style="background: white; border-radius: 8px; padding: 0.75rem 1rem; margin-top: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"><i class="fas fa-link"></i> Related Tools</h4>
        <div class="row" style="font-size: 0.8rem;">
            <div class="col-md-6">
                <ul class="list-unstyled mb-0" style="line-height: 1.8;">
                    <li><i class="fas fa-file-pdf text-muted"></i> <a href="merge-pdf.jsp">Merge PDF Files</a></li>
                    <li><i class="fas fa-cut text-muted"></i> <a href="split-pdf.jsp">Split PDF</a></li>
                    <li><i class="fas fa-stamp text-muted"></i> <a href="watermark-pdf.jsp">Watermark PDF</a></li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="list-unstyled mb-0" style="line-height: 1.8;">
                    <li><i class="fas fa-compress text-muted"></i> <a href="compress-pdf.jsp">Compress PDF</a></li>
                    <li><i class="fas fa-redo text-muted"></i> <a href="rotate-pdf.jsp">Rotate PDF</a></li>
                    <li><i class="fas fa-images text-muted"></i> <a href="pdf-to-images.jsp">PDF to Images</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Important Notice -->
    <div style="background: #fff3cd; border: 2px solid #ff9800; border-radius: 8px; padding: 0.75rem 1rem; margin-top: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08); font-size: 0.8rem;">
        <h4 style="font-size: 0.9rem; margin-bottom: 0.4rem; color: #ff9800;"><i class="fas fa-exclamation-triangle"></i> Important: Client-Side Limitation</h4>
        <p style="margin-bottom: 0.4rem; line-height: 1.4;"><strong>JavaScript PDF encryption is not currently supported in browsers.</strong> True PDF password protection requires server-side processing or native desktop applications.</p>
        <p style="margin-bottom: 0; line-height: 1.4;"><strong>This tool is a work in progress.</strong> We're working on a server-side implementation for secure PDF encryption.</p>
    </div>

    <!-- About Section -->
    <div style="background: white; border-radius: 8px; padding: 0.75rem 1rem; margin-top: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08); font-size: 0.8rem;">
        <h4 style="font-size: 0.9rem; margin-bottom: 0.4rem; color: #667eea;"><i class="fas fa-info-circle"></i> Recommended Alternatives</h4>
        <p style="margin-bottom: 0.4rem; line-height: 1.4;"><strong>Desktop Tools (Free):</strong></p>
        <ul style="margin-bottom: 0.5rem; padding-left: 1.5rem;">
            <li><strong>QPDF:</strong> Command-line tool - <code>qpdf --encrypt user-pass owner-pass 128 -- input.pdf output.pdf</code></li>
            <li><strong>PDFtk:</strong> Free desktop tool with GUI - <a href="https://www.pdflabs.com/tools/pdftk-the-pdf-toolkit/" target="_blank">pdflabs.com</a></li>
            <li><strong>Adobe Acrobat:</strong> Professional solution with full encryption support</li>
        </ul>
        <p style="margin-bottom: 0; line-height: 1.4;"><strong>Why not client-side?</strong> PDF encryption requires specific cryptographic implementations that ensure compatibility with all PDF readers (Adobe, Preview, Chrome, etc.). JavaScript PDF libraries don't have this capability yet.</p>
    </div>

    <div style="margin-top: 0.75rem;">
        <div class="sharethis-inline-share-buttons"></div>
        <%@ include file="thanks.jsp"%>
        <%@ include file="addcomments.jsp"%>
    </div>
</div>

<!-- Load PDF library with encryption support -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.js"></script>

<script>
    var selectedFile = null;

    // Debug: Check what's available
    console.log('PDFLib available:', typeof PDFLib);
    console.log('Window keys:', Object.keys(window).filter(k => k.toLowerCase().includes('pdf')));

    // Drag and drop handlers
    var dropArea = document.getElementById('fileDropArea');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, function() {
            dropArea.classList.add('drag-over');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, function() {
            dropArea.classList.remove('drag-over');
        }, false);
    });

    dropArea.addEventListener('drop', function(e) {
        var dt = e.dataTransfer;
        var files = dt.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            document.getElementById('pdfInput').files = files;
            handleFileSelect({ target: { files: files } });
        }
    }, false);

    function handleFileSelect(event) {
        var file = event.target.files[0];
        if (!file || file.type !== 'application/pdf') {
            alert('Please select a valid PDF file.');
            return;
        }

        selectedFile = file;

        // Display file info
        var fileInfo = document.getElementById('fileInfo');
        var fileSizeKB = (file.size / 1024).toFixed(2);
        var fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        var sizeDisplay = file.size > 1024 * 1024 ? fileSizeMB + ' MB' : fileSizeKB + ' KB';

        fileInfo.innerHTML =
            '<div class="file-info">' +
            '<div style="font-weight: 600; margin-bottom: 0.5rem; color: #667eea;"><i class="fas fa-check-circle"></i> File Selected</div>' +
            '<div class="file-info-item">' +
            '<span><i class="fas fa-file-pdf"></i> Name:</span>' +
            '<span style="font-weight: 600;">' + file.name + '</span>' +
            '</div>' +
            '<div class="file-info-item">' +
            '<span><i class="fas fa-weight"></i> Size:</span>' +
            '<span style="font-weight: 600;">' + sizeDisplay + '</span>' +
            '</div>' +
            '<div class="file-info-item">' +
            '<span><i class="fas fa-calendar"></i> Modified:</span>' +
            '<span style="font-weight: 600;">' + new Date(file.lastModified).toLocaleDateString() + '</span>' +
            '</div>' +
            '</div>';

        fileInfo.style.display = 'block';

        // Enable protect button if password is entered
        checkFormValidity();
    }

    // Check form validity
    function checkFormValidity() {
        var password = document.getElementById('passwordInput').value;
        var confirmPass = document.getElementById('confirmPassword').value;
        var protectBtn = document.getElementById('protectBtn');

        if (selectedFile && password && confirmPass && password === confirmPass) {
            protectBtn.disabled = false;
        } else {
            protectBtn.disabled = true;
        }
    }

    document.getElementById('passwordInput').addEventListener('input', checkFormValidity);
    document.getElementById('confirmPassword').addEventListener('input', checkFormValidity);

    // Toggle password visibility
    function togglePassword() {
        var showPass = document.getElementById('showPassword').checked;
        var passInput = document.getElementById('passwordInput');
        var confirmInput = document.getElementById('confirmPassword');

        passInput.type = showPass ? 'text' : 'password';
        confirmInput.type = showPass ? 'text' : 'password';
    }

    // Show loading state
    function showLoading(message) {
        document.getElementById('outputArea').innerHTML =
            '<div style="background: white; border-radius: 8px; padding: 3rem; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">' +
            '<div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>' +
            '<p style="color: #495057; margin: 0;">' + message + '</p>' +
            '</div>';
    }

    // Protect PDF
    async function protectPDF() {
        if (!selectedFile) {
            alert('Please upload a PDF file.');
            return;
        }

        var password = document.getElementById('passwordInput').value;
        var confirmPass = document.getElementById('confirmPassword').value;

        if (!password || !confirmPass) {
            alert('Please enter and confirm your password.');
            return;
        }

        if (password !== confirmPass) {
            alert('Passwords do not match. Please try again.');
            return;
        }

        if (password.length < 4) {
            alert('Password must be at least 4 characters long.');
            return;
        }

        showLoading('Encrypting PDF...');

        try {
            var fileReader = new FileReader();
            fileReader.readAsArrayBuffer(selectedFile);

            fileReader.onload = async function(e) {
                try {
                    var arrayBuffer = e.target.result;
                    var existingPdfBytes = new Uint8Array(arrayBuffer);

                    // Check if library is loaded
                    if (typeof PDFLib === 'undefined') {
                        throw new Error('PDF library not loaded. Please refresh the page and try again.');
                    }

                    var pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

                    // Get permissions
                    var permissions = {
                        printing: document.getElementById('permPrinting').checked,
                        modifying: document.getElementById('permModifying').checked,
                        copying: document.getElementById('permCopying').checked,
                        annotating: document.getElementById('permAnnotating').checked,
                        fillingForms: document.getElementById('permForms').checked,
                        contentAccessibility: document.getElementById('permAccessibility').checked,
                        documentAssembly: true
                    };

                    // Encrypt the PDF using @cantoo/pdf-lib
                    await pdfDoc.encrypt({
                        userPassword: password,
                        ownerPassword: password,
                        permissions: permissions
                    });

                    var pdfBytes = await pdfDoc.save();
                    var pageCount = pdfDoc.getPageCount();

                    // Show success
                    var originalName = selectedFile.name.replace('.pdf', '');
                    var protectedName = originalName + '_protected.pdf';

                    document.getElementById('outputArea').innerHTML =
                        '<div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">' +
                        '<h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: #28a745;"><i class="fas fa-check-circle"></i> PDF Protected Successfully</h3>' +
                        '<div style="background: #d1f4d1; border: 2px solid #28a745; border-radius: 8px; padding: 1.5rem; text-align: center;">' +
                        '<i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 1rem; color: #28a745;"></i><br>' +
                        '<strong style="font-size: 1.1rem; color: #28a745;">Encryption Complete</strong><br>' +
                        '<p style="font-size: 0.9rem; margin: 1rem 0; color: #495057;">Your PDF has been secured with password protection.</p>' +
                        '</div>' +
                        '<div style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 1rem; margin-top: 1rem;">' +
                        '<div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: #495057;">Protected File Details:</div>' +
                        '<div style="font-size: 0.8rem; color: #495057;">' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">' +
                        '<span><i class="fas fa-file-pdf"></i> Filename:</span>' +
                        '<span style="font-weight: 600;">' + protectedName + '</span>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">' +
                        '<span><i class="fas fa-file-alt"></i> Pages:</span>' +
                        '<span style="font-weight: 600;">' + pageCount + '</span>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between;">' +
                        '<span><i class="fas fa-shield-alt"></i> Encryption:</span>' +
                        '<span style="font-weight: 600;">128-bit AES</span>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<button class="pdf-btn" onclick="downloadPDF(\'' + protectedName.replace(/'/g, "\\'") + '\')" style="margin-top: 1rem;">' +
                        '<i class="fas fa-download"></i> Download Protected PDF' +
                        '</button>' +
                        '<button class="pdf-btn secondary" onclick="resetForm()">' +
                        '<i class="fas fa-redo"></i> Protect Another PDF' +
                        '</button>' +
                        '</div>';

                    // Store the protected PDF bytes globally for download
                    window.protectedPdfBytes = pdfBytes;

                } catch (error) {
                    console.error('Error protecting PDF:', error);
                    document.getElementById('outputArea').innerHTML =
                        '<div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">' +
                        '<h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: #dc3545;"><i class="fas fa-exclamation-circle"></i> Error</h3>' +
                        '<div style="background: #ffd7d5; border: 2px solid #dc3545; padding: 1rem; border-radius: 8px;">' +
                        '<strong>Error:</strong> ' + error.message + '<br><br>' +
                        '<small>Please ensure the PDF is not corrupted and try again.</small>' +
                        '</div>' +
                        '</div>';
                }
            };

        } catch (error) {
            console.error('Error reading file:', error);
            alert('Error reading file. Please try again.');
        }
    }

    // Download protected PDF
    function downloadPDF(fileName) {
        if (!window.protectedPdfBytes) {
            alert('No protected PDF available for download.');
            return;
        }

        var blob = new Blob([window.protectedPdfBytes], { type: 'application/pdf' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    // Reset form
    function resetForm() {
        selectedFile = null;
        window.protectedPdfBytes = null;
        document.getElementById('pdfInput').value = '';
        document.getElementById('passwordInput').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('protectBtn').disabled = true;

        document.getElementById('outputArea').innerHTML =
            '<div class="output-placeholder">' +
            '<i class="fas fa-arrow-left"></i>' +
            '<h4>Upload and Protect PDF</h4>' +
            '<p>Upload a PDF file and set a password<br>to see the protected result here.</p>' +
            '</div>';
    }
</script>

</div>
</div>
<%@ include file="body-close.jsp"%>
